# Script github action kanged from Ivan @reddxae with little bit my modification and addition
name: Build kernel (GPT Version)
on:
  #schedule:
    #- cron: '0 4 * * *'  # Runs every day at 04:00 UTC
  workflow_dispatch: # Allow manual trigger if needed
  #push:
    
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4 

      - name: Set up the toolchain
        run: |
          sudo apt update
          sudo apt purge -y firefox
          sudo apt-mark hold firefox
          sudo apt upgrade -y
          sudo apt install -y \
          bc bison flex build-essential git curl \
          libelf-dev libssl-dev liblz4-tool lz4 \
          pahole dwarves cpio \
          python3 python-is-python3 \
          tar perl zip zlib1g-dev

      - name: Clone source
        run: |
          git clone --depth=1 -b android13-5.15 https://github.com/samsung-sm8550/kernel_samsung_sm8550-common.git kernel

          # Determine the current kernel version
          echo "KERNEL_VERSION=$(grep -m1 '^SUBLEVEL =' ./kernel/Makefile | awk '{print $3}')" >> $GITHUB_ENV
          
      - name: Apply the KernelSU Next, SUSFS, manual hooks patch and Baseband Guard
        run: |
          set -euxo pipefail
          cd kernel
          # Determine the tag of the latest release of KernelSU Next
          echo "KSUNEXT_VERSION=$(curl -s "https://api.github.com/repos/KernelSU-Next/KernelSU-Next/tags" \
          | jq -r '.[0].name' | sed 's/^v//' | tr -d '.')" >> $GITHUB_ENV

          # Integrate the latest next-susfs version of KernelSU Next into the source
          curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s dev_susfs

          # Compute version code = commit count + 10200 (same scheme as KernelSU CI)
          COMMITS="$(git -C "./KernelSU-Next" rev-list --count HEAD || echo 0)"
          NEXT_VER_CODE=$((30000 + COMMITS))
          echo "NEXT_VER_CODE=$NEXT_VER_CODE" >> "$GITHUB_ENV"
               
          
          # Integrate SUSFS 2.0.0
          git clone -b gki-android13-5.15 https://gitlab.com/simonpunk/susfs4ksu.git
      

          # Determine susfs version
          cd susfs4ksu
          SUSFS_COMMIT=$(git rev-parse --short HEAD)
          SUSFS_VERSION=$(sed -n 's/.*#define[[:space:]]\+SUSFS_VERSION[[:space:]]\+"v\{0,1\}\([0-9.]\+\)".*/\1/p' kernel_patches/include/linux/susfs.h | tr -d '.')
          echo "SUSFS_VERSION=$SUSFS_VERSION" >> "$GITHUB_ENV"
          echo "SUSFS_COMMIT=$SUSFS_COMMIT" >> "$GITHUB_ENV"
          cd ..

          # Begin susfs patching
          cp -rv ./susfs4ksu/kernel_patches/fs/* ./fs/
          cp -rv ./susfs4ksu/kernel_patches/include/linux/* ./include/linux/
          cp ./susfs4ksu/kernel_patches/50_add_susfs_in_gki-android13-5.15.patch ./
          patch -p1 < ./50_add_susfs_in_gki-android13-5.15.patch
          #patch -p1 --fuzz=3 < "${GITHUB_WORKSPACE}/rezoss_next3_susfs2.patch"
          
          # Integrate manual hook 1.6
          curl -L -o manual-hook.patch https://github.com/SukiSU-Ultra/SukiSU_patch/raw/83aa64b7548890bb1f2eff6c990c03a1802df27b/hooks/scope_min_manual_hooks_v1.6.patch
          patch -p1 --fuzz=3 < manual-hook.patch
          echo "CONFIG_KSU=y" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_KPROBES_HOOK=n" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_SU=n" >> ./arch/arm64/configs/gki_defconfig 
          echo "CONFIG_KSU_SUSFS=y" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> ./arch/arm64/configs/gki_defconfig
          
      - name: Apply S23 Performance Optimizations (Clean + Fixed Cluster Limiter)
        run: |
          cd kernel
          set -e
          echo ">>> Applying Clean S23 Optimizations..."

          ############################################################
          # 1. OPTIMIZED INT_SQRT (Safe Replacement)
          ############################################################
          cat << 'EOF' > lib/math/int_sqrt.c
          #include <linux/export.h>
          #include <linux/bitops.h>
          #include <linux/kernel.h>

          unsigned long int_sqrt(unsigned long x)
          {
              unsigned long tmp;
              unsigned long place;
              unsigned long root = 0;

              if (x <= 1)
                  return x;

              place = 1UL << (BITS_PER_LONG - 2);
              while (place > x)
                  place >>= 2;

              while (place) {
                  tmp = root + place;
                  root >>= 1;
                  if (x >= tmp) {
                      x -= tmp;
                      root += place;
                  }
                  place >>= 2;
              }
              return root;
          }
          EXPORT_SYMBOL(int_sqrt);
          EOF

          ############################################################
          # 2. S23 CPUFREQ CLUSTER LIMITER (Fixed Version)
          ############################################################
          cat << 'EOF' >> drivers/cpufreq/cpufreq.c

          /* ===== S23 Cluster Limiter ===== */
          static unsigned int s23_cluster_min[3] = {0, 0, 0};

          static int s23_cluster_index(unsigned int cpu)
          {
              if (cpu <= 2)
                  return 0;
              if (cpu <= 6)
                  return 1;
              return 2;
          }

          static ssize_t show_s23_cluster_min(struct cpufreq_policy *policy, char *buf)
          {
              int idx = s23_cluster_index(policy->cpu);
              return sprintf(buf, "%u\n", s23_cluster_min[idx]);
          }

          static ssize_t store_s23_cluster_min(struct cpufreq_policy *policy,
                                               const char *buf, size_t count)
          {
              unsigned int val;
              int idx = s23_cluster_index(policy->cpu);

              if (kstrtouint(buf, 10, &val))
                  return -EINVAL;

              s23_cluster_min[idx] = val;

              if (policy) {
                  policy->min = max(policy->min, val);
                  cpufreq_update_policy(policy->cpu);
              }

              return count;
          }

          cpufreq_freq_attr_rw(s23_cluster_min);
          /* ================================ */
          EOF

          # Add attribute to cpufreq attribute table
          sed -i '/&scaling_min_freq.attr,/a \
              \t&s23_cluster_min.attr,' drivers/cpufreq/cpufreq.c

          # Enforce cluster min during policy update
          sed -i '/new_data.max = freq_qos_read_value/a \
              { \
                  unsigned int idx = s23_cluster_index(policy->cpu); \
                  if (s23_cluster_min[idx]) \
                      new_data.min = max(new_data.min, s23_cluster_min[idx]); \
              }' drivers/cpufreq/cpufreq.c

          ############################################################
          # 3. ARM64 PREFETCH OPTIMIZATION
          ############################################################
          sed -i '/D_h\t.req\tx14/a \
              \tprfm pldl1strm, [src, #(1*L1_CACHE_BYTES)]' \
              arch/arm64/lib/copy_template.S

          ############################################################
          # 4. NETWORK OPTIMIZATION
          ############################################################
          sed -i 's/_SK_MEM_PACKETS\t\t256/_SK_MEM_PACKETS\t\t1024/' \
              include/net/sock.h

          ############################################################
          # 5. EXT4 PERFORMANCE
          ############################################################
          sed -i 's/JBD2_DEFAULT_MAX_COMMIT_AGE 5/JBD2_DEFAULT_MAX_COMMIT_AGE 30/' \
              include/linux/jbd2.h

          ############################################################
          # 6. F2FS TUNING
          ############################################################
          sed -i 's/DEFAULT_IO_TIMEOUT\t(msecs_to_jiffies(20))/DEFAULT_IO_TIMEOUT\t(msecs_to_jiffies(6))/' \
              fs/f2fs/f2fs.h || true

          sed -i 's/DEF_MIN_FSYNC_BLOCKS\t8/DEF_MIN_FSYNC_BLOCKS\t20/' \
              fs/f2fs/segment.h || true

          ############################################################
          # 7. LOG SPAM REDUCTION (Safe)
          ############################################################
          sed -i 's/pr_warn_ratelimited("IRQ%u: set affinity failed/pr_debug_ratelimited("IRQ%u: set affinity failed/' \
              kernel/irq/cpuhotplug.c

          ############################################################
          # 8. CONFIG OPTIMIZATION (GKI DEFCONFIG)
          ############################################################
          DEFCONFIG=arch/arm64/configs/gki_defconfig

          {
            echo "CONFIG_TCP_CONG_ADVANCED=y"
            echo "CONFIG_NET_SCH_FQ=y"
            echo "CONFIG_TCP_CONG_BBR=y"
            echo 'CONFIG_DEFAULT_TCP_CONG="bbr"'
            echo "CONFIG_LRU_GEN=y"
            echo "CONFIG_LRU_GEN_ENABLED=y"
            echo "CONFIG_RCU_LAZY=y"
            echo "CONFIG_RCU_EXPERT=y"
            echo "CONFIG_LTO_CLANG_THIN=n"
            echo "CONFIG_LTO_CLANG_FULL=y"
            echo "CONFIG_WERROR=n"
          } >> $DEFCONFIG

          ############################################################
          # 9. FORCE HZ 300
          ############################################################
          sed -i 's/CONFIG_HZ_250=y/# CONFIG_HZ_250 is not set/' $DEFCONFIG
          sed -i 's/CONFIG_HZ=250/CONFIG_HZ=300/' $DEFCONFIG
          echo "CONFIG_HZ_300=y" >> $DEFCONFIG

          echo ">>> Clean S23 Optimization Complete."

      - name: Set up swap space
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 16

      - name: Build the kernel
        run: |
          set -euxo pipefail
          cd kernel
          chmod +x scripts/build.sh
          ./scripts/build.sh 2>&1 | tee "$GITHUB_WORKSPACE/build.log"

      - name: Package image with AnyKernel3
        id: package
        run: |
          set -euxo pipefail
          unzip "${GITHUB_WORKSPACE}/anykernel.zip" -d anykernel/
          cp kernel/out/arch/arm64/boot/Image.gz anykernel/
          # Build final name
          ZIP_NAME="common-5.15.${KERNEL_VERSION}-3d64R-next${KSUNEXT_VERSION}_${NEXT_VER_CODE}-susfs${SUSFS_VERSION}_${SUSFS_COMMIT}-manual-$(date +%d%m%y-%H%M%S)"
          cd anykernel
          zip -r0 ../"${ZIP_NAME}".zip ./*
          echo "zip_path=$GITHUB_WORKSPACE/${ZIP_NAME}.zip" >> "$GITHUB_OUTPUT"
          echo "zip_name=${ZIP_NAME}" >> "$GITHUB_OUTPUT"
          cd ..

      - name: Upload the flashable kernel
        uses: actions/upload-artifact@v4
        with:
          name: ${{steps.package.outputs.zip_name}}
          path: anykernel/
      
      - name: Create GitHub Release and upload asset
        if: github.event_name != 'pull_request'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: experimental_build-${{ github.run_id }} 
          target_commitish: ${{ github.sha }}
          name: "Kernel Build by ${{ github.repository }}"
          generate_release_notes: true
          files: ${{ steps.package.outputs.zip_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}   
