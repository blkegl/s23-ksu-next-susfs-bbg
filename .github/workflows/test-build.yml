name: Build kernel using KSU Next, susfs and scope-minimized manual hooks

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
        
      - name: Set up the toolchain
        run: |
          sudo apt update
          sudo apt purge -y firefox
          sudo apt-mark hold firefox
          sudo apt upgrade -y
          sudo apt install -y \
          bc bison flex build-essential git jq curl \
          libelf-dev libssl-dev liblz4-tool lz4 \
          pahole dwarves cpio \
          python3 python-is-python3 \
          tar perl zip zlib1g-dev

      - name: Clone source
        run: |
          git clone --depth=1 -b android13-5.15 https://github.com/samsung-sm8550/kernel_samsung_sm8550-common.git kernel

          # Determine the current kernel version
          echo "KERNEL_VERSION=$(grep -m1 '^SUBLEVEL =' ./kernel/Makefile | awk '{print $3}')" >> $GITHUB_ENV
     
      - name: Apply Optimized Performance & Feature Injection
        run: |
          set -euxo pipefail
          cd kernel

          echo ">>> Injecting Boeffla Wakelock Blocker..."
          BOEFFLA_RAW="https://raw.githubusercontent.com/qwerty12/SM-G9750_GrainGripper/master/drivers/base/power"

          if [ ! -f drivers/misc/boeffla_wl_blocker.c ]; then
            wget -q -O drivers/misc/boeffla_wl_blocker.c "$BOEFFLA_RAW/boeffla_wl_blocker.c"
            wget -q -O drivers/misc/boeffla_wl_blocker.h "$BOEFFLA_RAW/boeffla_wl_blocker.h"
            cp drivers/misc/boeffla_wl_blocker.h include/linux/boeffla_wl_blocker.h
          fi

          sed -i 's/^extern char list_wl_search\[LENGTH_LIST_WL_SEARCH\];/char list_wl_search[LENGTH_LIST_WL_SEARCH] = {0};/' drivers/misc/boeffla_wl_blocker.c
          sed -i 's/^extern bool wl_blocker_active;/bool wl_blocker_active = false;/' drivers/misc/boeffla_wl_blocker.c
          sed -i 's/^extern bool wl_blocker_debug;/bool wl_blocker_debug = false;/' drivers/misc/boeffla_wl_blocker.c

          if ! grep -q CONFIG_BOEFFLA_WL_BLOCKER drivers/misc/Kconfig; then
            cat >> drivers/misc/Kconfig <<'EOF'

          config BOEFFLA_WL_BLOCKER
              bool "Boeffla Wakelock Blocker"
              default y
              help
                Allows blocking wakelocks in kernel.

          config BOEFFLA_WL_BLOCKER_DEFAULT
              string "Default wakelock block list"
              depends on BOEFFLA_WL_BLOCKER
              default ""
          EOF
          fi

          grep -q boeffla_wl_blocker.o drivers/misc/Makefile || \
            echo 'obj-$(CONFIG_BOEFFLA_WL_BLOCKER) += boeffla_wl_blocker.o' >> drivers/misc/Makefile

          # ==========================================================
          # PART B — CONFIG FRAGMENT (NO DUPLICATES)
          # ==========================================================
          DEFCONFIG="arch/arm64/configs/gki_defconfig"

          add_config() {
            grep -q "^$1" "$DEFCONFIG" || echo "$1" >> "$DEFCONFIG"
          }

          echo ">>> Applying Config Tweaks"
          add_config CONFIG_WQ_POWER_EFFICIENT_DEFAULT=y
          add_config CONFIG_LRNG=y
          add_config CONFIG_TCP_CONG_ADVANCED=y
          add_config CONFIG_NET_SCH_FQ=y
          add_config CONFIG_DEFAULT_FQ=y
          add_config CONFIG_TCP_CONG_BBR=y
          add_config CONFIG_DEFAULT_BBR=y
          add_config CONFIG_LRU_GEN=y
          add_config CONFIG_LRU_GEN_ENABLED=y
          add_config CONFIG_LRU_GEN_STATS=y
          add_config CONFIG_ZRAM=m
          add_config CONFIG_ZSMALLOC=m
          add_config CONFIG_BOEFFLA_WL_BLOCKER=y
          add_config 'CONFIG_BOEFFLA_WL_BLOCKER_DEFAULT="lps_wakelock,wlan_ctrl_wakelock"'
          add_config CONFIG_RCU_LAZY=y
          add_config CONFIG_RCU_LAZY_DEFAULT_OFF=n
          add_config CONFIG_RCU_EXPERT=y
          add_config CONFIG_RCU_BOOST=y
          add_config CONFIG_RCU_BOOST_DELAY=500
          add_config CONFIG_RCU_NOCB_CPU=y
          add_config CONFIG_AUDITSYSCALL=n
          add_config CONFIG_LTO_CLANG_FULL=y
          add_config CONFIG_LTO_CLANG_THIN=n
          add_config CONFIG_WERROR=n

          sed -i 's/CONFIG_DEFAULT_TCP_CONG="cubic"/CONFIG_DEFAULT_TCP_CONG="bbr"/' "$DEFCONFIG"
          sed -i 's/CONFIG_DEFAULT_CUBIC=y/# CONFIG_DEFAULT_CUBIC is not set/' "$DEFCONFIG"

          sed -i 's/CONFIG_HZ_250=y/# CONFIG_HZ_250 is not set/' "$DEFCONFIG"
          sed -i 's/CONFIG_HZ=250/CONFIG_HZ=300/' "$DEFCONFIG"
          add_config CONFIG_HZ_300=y

          # ==========================================================
          # PART C — INT_SQRT
          # ==========================================================
          echo "Overwriting int_sqrt.c"
          cat > lib/math/int_sqrt.c <<'EOF'
          #include <linux/export.h>
          #include <linux/bitops.h>
          #include <linux/limits.h>
          #include <linux/kernel.h>

          unsigned long int_sqrt(unsigned long x)
          {
              register unsigned long tmp;
              register unsigned long place;
              register unsigned long root = 0;

              if (x <= 1) return x;

              place = 1UL << (BITS_PER_LONG - 2);
              while (place > x) place >>= 2;

              while (place) {
                  tmp = root + place;
                  root >>= 1;
                  if (x >= tmp) {
                      x -= tmp;
                      root += place;
                  }
                  place >>= 2;
              }
              return root;
          }
          EXPORT_SYMBOL(int_sqrt);
          EOF

          # ==========================================================
          # PART D — CPUFREQ LIMITER
          # ==========================================================
          echo "Injecting S23 CPUFreq Limiter"
          if ! grep -q S23_LIMITER drivers/cpufreq/cpufreq.c; then
            cat >> drivers/cpufreq/cpufreq.c <<'EOF'

          /* --- S23_LIMITER --- */
          static unsigned int min_limit[3] = {INT_MAX, INT_MAX, INT_MAX};

          static int get_index_by_cpu(const unsigned int cpu)
          {
              if (cpu <= 2) return 0;
              if (cpu <= 6) return 1;
              return 2;
          }

          static ssize_t show_scaling_min_freq_limit(struct cpufreq_policy *policy, char *buf)
          {
              return sprintf(buf, "%u\n", min_limit[get_index_by_cpu(policy->cpu)]);
          }

          static ssize_t store_scaling_min_freq_limit(struct cpufreq_policy *policy,
                                                      const char *buf, size_t count)
          {
              unsigned long val;
              if (sscanf(buf, "%u", &val) != 1) return -EINVAL;
              min_limit[get_index_by_cpu(policy->cpu)] = val;
              return count;
          }
          /* --- END S23_LIMITER --- */
          EOF
          fi

          # ==========================================================
          # PART E — SAFE ONE-LINER TWEAKS
          # ==========================================================
          echo "Applying One-liner Tweaks"
          grep -q pldl1strm arch/arm64/lib/copy_template.S || \
            sed -i '/ldp1.*src, #16/a \ \tprfm\ \ pldl1strm, [src, #(4*L1_CACHE_BYTES)]' arch/arm64/lib/copy_template.S

          sed -i 's/__attribute__((aligned(4)));/__attribute__((aligned(8)));/' include/linux/fs.h
          sed -i 's/_SK_MEM_PACKETS\t\t256/_SK_MEM_PACKETS\t\t1024/' include/net/sock.h
          sed -i 's/JBD2_DEFAULT_MAX_COMMIT_AGE 5/JBD2_DEFAULT_MAX_COMMIT_AGE 30/' include/linux/jbd2.h
          sed -i 's/msecs_to_jiffies(20)/msecs_to_jiffies(6)/' fs/f2fs/f2fs.h
          sed -i 's/DEF_MIN_FSYNC_BLOCKS\t8/DEF_MIN_FSYNC_BLOCKS\t20/' fs/f2fs/segment.h
          sed -i 's/SCHED_FEAT(CACHE_HOT_BUDDY, true)/SCHED_FEAT(CACHE_HOT_BUDDY, false)/' kernel/sched/features.h
          sed -i 's/atomic_inc(&pm_abort_suspend);/if (atomic_inc_return_relaxed(&pm_abort_suspend) == 1)/' drivers/base/power/wakeup.c

          grep -q TCP_NODELAY net/ipv4/tcp.c || \
            sed -i '/sockopt_lock_sock(sk);/a \ \toptname=TCP_NODELAY;' net/ipv4/tcp.c

          grep -q healthd kernel/printk/printk.c || \
            sed -i '/devkmsg_emit/a \ \tif (strstr(line,"healthd")||strstr(line,"logd")||strstr(line,"dashd")){kfree(buf);return len;}' kernel/printk/printk.c

          sed -i 's/pr_warn_ratelimited("IRQ/pr_debug_ratelimited("IRQ/' kernel/irq/cpuhotplug.c

          grep -q "int copy_flags = 0;" fs/namespace.c || \
            sed -i '/copy_flags |= CL_COPY_MNT_NS/i \ \tint copy_flags = 0;' fs/namespace.c

          # ==========================================================
          # PART F — RWONCE FIX
          # ==========================================================
          cat > arch/arm64/include/asm/rwonce.h <<'EOF'
          #ifndef __ASM_RWONCE_H
          #define __ASM_RWONCE_H
          #define __READ_ONCE(x) (*(const volatile typeof(x) *)&(x))
          #include <asm-generic/rwonce.h>
          #endif
          EOF

          echo ">>> Optimized Injection Complete"


      - name: Create 50GB swap (LTO)
        run: |
          sudo swapoff -a || true
          sudo rm -f /swapfile
          # Using dd is more reliable for swap files on some runners
          sudo dd if=/dev/zero of=/swapfile bs=1M count=51200
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: Build the kernel
        run: |
          set -euxo pipefail
          cd kernel
          chmod +x scripts/build.sh
          ./scripts/build.sh 2>&1 | tee "$GITHUB_WORKSPACE/build.log"

      - name: Package image with AnyKernel3
        id: package
        run: |
          set -euxo pipefail
          unzip "${GITHUB_WORKSPACE}/anykernel.zip" -d anykernel/
          cp kernel/out/arch/arm64/boot/Image.gz anykernel/
          # Build final name
          ZIP_NAME="common-5.15.${KERNEL_VERSION}-3d64R-next${KSUNEXT_VERSION}_${NEXT_VER_CODE}-susfs${SUSFS_VERSION}_${SUSFS_COMMIT}-manual-$(date +%d%m%y-%H%M%S)"
          cd anykernel
          zip -r0 ../"${ZIP_NAME}".zip ./*
          echo "zip_path=$GITHUB_WORKSPACE/${ZIP_NAME}.zip" >> "$GITHUB_OUTPUT"
          echo "zip_name=${ZIP_NAME}" >> "$GITHUB_OUTPUT"
          cd ..

      - name: Upload the flashable kernel
        uses: actions/upload-artifact@v4
        with:
          name: ${{steps.package.outputs.zip_name}}
          path: anykernel/

      - name: Create GitHub Release and upload asset
        if: github.event_name != 'pull_request'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: experimental_build-${{ github.run_id }}
          target_commitish: ${{ github.sha }}
          name: "Kernel Build by ${{ github.repository }}"
          generate_release_notes: true
          files: ${{ steps.package.outputs.zip_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
